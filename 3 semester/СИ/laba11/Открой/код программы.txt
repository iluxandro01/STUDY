#include <stdio.h>
#include <ctype.h>

void TreatmentString(char *str, int *isEven);

int main() {
    FILE *in;
    char str[256]; //буфферная строка
    int isEven = 0; //счетчик слов

    in = fopen("../Fin.txt", "rt");

    if (in == NULL) { //проверка на наличие файла
        perror("ERROR with a reading file ");
        return -1;
    }

    if (getc(in) == EOF) { //проверка на пустоту файла
        printf("File is empty!\n");
        return -2;
    }

    rewind(in); //переход на начало файла
    remove("../Fout.txt");
    while (fgets(str, sizeof(str), in) != NULL) { //считать построчно, пока не конец файла
        TreatmentString(str, &isEven);
    }
    fclose(in);
    return 0;
}
/**
 * Функция обработки строки
 * \Description_of_algorithm
 * Пока не закончится строка выполняем: <br>
 * 1) Пропускаем пробелы и знаки препинания, т.е. ищем слово. <br>
 * 2) Проверяем, четное слово или нет <br>
 * 3) Слово четное - записываем все слово в файл без изменений <br>
 * 4) Слово нечетное: <br>
 * 4.1) Если слово начинается с верхнего регистра - не записываем это слово <br>
 * 4.2) Если слово начинается с нижнего регистра - меняем регистр каждой
 * буквы в слове и записываем ее в файл
 * @param str - входная, обрабатываемая строка
 * @param isEven - счетчик слов во всем файле
 */
void TreatmentString(char *str, int *isEven) {
    FILE *out;
    out = fopen("../Fout.txt", "a+t");
    int i = 0; //итератор по строке
    while (str[i] != '\0') { //пока не закончится строка
        while ((str[i] == ' ' || str[i] == ',' || str[i] == '.') && str[i] != '\0')
            i++; //пропускаем пробелы и знаки препинания, если не конец строки
                 //то есть ищем какое-то слово
        if (*(isEven) % 2 == 0) {  //встретили слово -> проверяем четное оно или нет
            //если слово четное, то просто полностью записываем его, ничего не делая с ним
            while (str[i] != ' ' && str[i] != '\0') {  //записываем слово в файл
                fwrite(&str[i], sizeof(char), 1, out);
                i++;
            }
            if (str[i] != '\0') //если строка не закончилась
                fwrite(" ", sizeof(char), 1, out); //добавляем после слова пробел
        } else {
            /*
            Если слово нечетное, то существует два варианта развития событий:
            1) Если первая буква верхнего регистра - удаляем это слово, т.е.
            просто не записываем его
            2) Если первая буква нижнего регистра - то меняем в этом слове регистр
             каждой буквы (с верхнего на нижний и с нижнего на верхний)
             */
            if (isupper(str[i])) { //слово начинается с верхнего регистра?
                while (str[i] != ' ' && str[i] != '\0') i++; //да, пропускаем его
            } else { //нет, регистр нижний
                while (str[i] != ' ' && str[i] != '\0') { //идем по всему слову
                    str[i] = isupper(str[i]) ? tolower(str[i]) : toupper(str[i]);
                    //меняем регистр
                    fwrite(&str[i], sizeof(char), 1, out); //записываем в файл
                    i++;
                }
                if (str[i] != '\0') //если строка не закончилась
                    fwrite(" ", sizeof(char), 1, out); //добавляем после слова пробел
            }
        }
        (*isEven)++; //счетчик слов
    }
}
